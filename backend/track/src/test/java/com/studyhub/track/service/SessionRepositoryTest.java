package com.studyhub.track.service;

import com.studyhub.track.adapter.db.session.SessionDao;
import com.studyhub.track.adapter.db.session.SessionRepositoryImpl;
import com.studyhub.track.domain.model.session.SessionRepository;
import com.studyhub.track.domain.model.session.Session;
import com.studyhub.track.util.SessionMother;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.data.jdbc.DataJdbcTest;
import org.springframework.test.annotation.Rollback;
import org.springframework.test.context.DynamicPropertyRegistry;
import org.springframework.test.context.DynamicPropertySource;
import org.springframework.test.context.TestPropertySource;
import org.springframework.test.context.jdbc.Sql;
import org.testcontainers.containers.PostgreSQLContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;

import java.util.UUID;

import static org.assertj.core.api.Assertions.assertThat;

@Testcontainers
@DataJdbcTest
@Rollback(false)
@Sql(scripts = "drop_session_table.sql", executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD)
@Sql(scripts = "init_session_db_data.sql", executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD)
@TestPropertySource(properties = {
		"spring.datasource.url=jdbc:postgresql://localhost:${container.port}/sessiontest",
		"spring.datasource.username=timo",
		"spring.datasource.password=1234"
})
class SessionRepositoryTest {
	@Container
	static PostgreSQLContainer<?> postgres = new PostgreSQLContainer<>("postgres:15.2")
			.withDatabaseName("sessiontest")
			.withUsername("timo")
			.withPassword("1234");

	@DynamicPropertySource
	static void overrideProps(DynamicPropertyRegistry registry) {
		registry.add("spring.datasource.url", postgres::getJdbcUrl);
		registry.add("spring.datasource.username", postgres::getUsername);
		registry.add("spring.datasource.password", postgres::getPassword);
	}

	@Autowired
	SessionDao sessionRepository;

	SessionRepository repository;

	@BeforeEach
	void setUp() {
		repository = new SessionRepositoryImpl(sessionRepository);
	}

	@Test
	@DisplayName("Eine Session kann gespeichert werden")
	void saveSession() {
		Session session = SessionMother.createSessionWithNRandomBlocks(5);

		Session savedSession = repository.save(session);

		assertThat(savedSession).isNotNull();
		assertThat(savedSession.getFachId()).isNotNull();
		assertThat(savedSession.getBlocks()).hasSize(5);
	}

	@Test
	@DisplayName("Alle erstellte Sessions des Benutzers mit dem username 'alex' werden gefunden")
	void findAllByUsername() {
		String username = "alex";

		var sessions = repository.findAllByUsername(username);

		assertThat(sessions).isNotNull().hasSize(2);
		assertThat(sessions.get(0).getUsername()).isEqualTo(username);
		assertThat(sessions.get(1).getUsername()).isEqualTo(username);
	}

	@Test
	@DisplayName("Eine Session kann anhand der Fach-Id gel√∂scht werden")
	void deleteByFachId() {
		UUID fachId = UUID.fromString("33333333-3333-3333-3333-333333333333");

		long n = repository.deleteByFachId(fachId);

		assertThat(n).isEqualTo(1);
	}
}
